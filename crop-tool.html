<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•å“å›¾ç‰‡è£å‰ªå·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-weight: 500;
            color: #555;
        }

        select, input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #d4a373;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #d4a373;
            color: white;
        }

        .btn-primary:hover {
            background: #c49363;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .workspace {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-top: 20px;
        }

        .canvas-area {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #fafafa;
            position: relative;
            min-height: 600px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #imageCanvas {
            max-width: 100%;
            cursor: crosshair;
            border: 1px solid #ccc;
            background: white;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #d4a373;
        }

        .info-box h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }

        .info-box p {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
            margin: 5px 0;
        }

        .crop-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        .crop-list h3 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }

        .crop-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .crop-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        .crop-item-info {
            flex: 1;
            font-size: 12px;
        }

        .crop-item-name {
            font-weight: 600;
            color: #333;
        }

        .selection-rect {
            position: absolute;
            border: 2px dashed #d4a373;
            background: rgba(212, 163, 115, 0.1);
            pointer-events: none;
        }

        .status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 10px;
            font-size: 14px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .instructions {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #0066cc;
        }

        .instructions h2 {
            font-size: 16px;
            color: #0066cc;
            margin-bottom: 10px;
        }

        .instructions ol {
            margin-left: 20px;
            color: #333;
            line-height: 1.8;
        }

        .instructions li {
            margin-bottom: 5px;
        }

        @media (max-width: 1024px) {
            .workspace {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ å•å“å›¾ç‰‡è£å‰ªå·¥å…·</h1>
        <p class="subtitle">æ¡†é€‰æ¯ä¸ªå•å“åŒºåŸŸï¼Œè‡ªåŠ¨ä¿å­˜ä¸ºç‹¬ç«‹å›¾ç‰‡</p>

        <div class="instructions">
            <h2>ğŸ“‹ ä½¿ç”¨è¯´æ˜</h2>
            <ol>
                <li><strong>ç‚¹å‡»"ä¸Šä¼ å›¾ç‰‡"æŒ‰é’®</strong>ï¼Œä» pic æ–‡ä»¶å¤¹ä¸­é€‰æ‹©è¦è£å‰ªçš„åŸå›¾</li>
                <li>è®¾ç½®é›†æ•°å’Œç©¿æ­ç¼–å·ï¼ˆä¼šå½±å“ä¿å­˜çš„æ–‡ä»¶åï¼‰</li>
                <li>åœ¨å›¾ç‰‡ä¸ŠæŒ‰ä½é¼ æ ‡æ‹–åŠ¨æ¡†é€‰å•å“åŒºåŸŸ</li>
                <li>è¾“å…¥å•å“ç¼–å·ï¼ˆ1, 2, 3...ï¼‰ï¼Œç‚¹å‡»"è£å‰ªå¹¶ä¿å­˜"</li>
                <li>é‡å¤æ­¥éª¤3-4ï¼Œç›´åˆ°è£å‰ªå®Œæ‰€æœ‰å•å“</li>
                <li>ä¸Šä¼ ä¸‹ä¸€å¼ å›¾ç‰‡ç»§ç»­è£å‰ª</li>
            </ol>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>ä¸Šä¼ å›¾ç‰‡ï¼š</label>
                <input type="file" id="imageUpload" accept="image/*" onchange="loadUploadedImage()" style="padding: 6px;">
            </div>
            
            <div class="control-group" style="opacity: 0.6; pointer-events: none;">
                <label>æˆ–é€‰æ‹©å›¾ç‰‡ï¼š</label>
                <select id="imageSelect" disabled>
                    <option value="">-- è¯·å…ˆä¸Šä¼ å›¾ç‰‡ --</option>
                    <option value="pic/IMG_0829.jpg">IMG_0829.jpg (ç¬¬1é›†-ç¬¬1å¥—)</option>
                    <option value="pic/IMG_0830.jpg">IMG_0830.jpg (ç¬¬1é›†-ç¬¬2å¥—)</option>
                    <option value="pic/IMG_0831.JPG">IMG_0831.JPG (ç¬¬1é›†-ç¬¬3å¥—)</option>
                    <option value="pic/IMG_0832.JPG">IMG_0832.JPG (ç¬¬1é›†-ç¬¬4å¥—)</option>
                    <option value="pic/IMG_0833.JPG">IMG_0833.JPG (ç¬¬1é›†-ç¬¬5å¥—)</option>
                    <option value="pic/IMG_0834.JPG">IMG_0834.JPG (ç¬¬1é›†-ç¬¬6å¥—)</option>
                    <option value="pic/IMG_0835.JPG">IMG_0835.JPG (ç¬¬2é›†-ç¬¬1å¥—)</option>
                    <option value="pic/IMG_0836.JPG">IMG_0836.JPG (ç¬¬2é›†-ç¬¬2å¥—)</option>
                    <option value="pic/IMG_0837.JPG">IMG_0837.JPG (ç¬¬2é›†-ç¬¬3å¥—)</option>
                    <option value="pic/IMG_0838.JPG">IMG_0838.JPG (ç¬¬2é›†-ç¬¬4å¥—)</option>
                </select>
            </div>

            <div class="control-group">
                <label>é›†æ•°ï¼š</label>
                <input type="number" id="episode" value="1" min="1" max="10">
            </div>

            <div class="control-group">
                <label>ç©¿æ­ç¼–å·ï¼š</label>
                <input type="number" id="outfitNum" value="1" min="1" max="20">
            </div>

            <div class="control-group">
                <label>å•å“ç¼–å·ï¼š</label>
                <input type="number" id="itemNum" value="1" min="1" max="20">
            </div>

            <button class="btn-success" onclick="cropAndSave()" id="cropBtn" disabled>âœ‚ï¸ è£å‰ªå¹¶ä¿å­˜</button>
            <button class="btn-secondary" onclick="resetSelection()">ğŸ”„ é‡ç½®é€‰åŒº</button>
            <button class="btn-primary" onclick="downloadAll()">ğŸ“¦ ä¸‹è½½æ‰€æœ‰è£å‰ªå›¾</button>
        </div>

        <div id="status" class="status"></div>

        <div class="workspace">
            <div class="canvas-area">
                <canvas id="imageCanvas"></canvas>
            </div>

            <div class="sidebar">
                <div class="info-box">
                    <h3>ğŸ“ å½“å‰é€‰åŒº</h3>
                    <p id="selectionInfo">æœªé€‰æ‹©åŒºåŸŸ</p>
                    <p style="margin-top: 10px; font-size: 12px; color: #999;">
                        æç¤ºï¼šæ‹–åŠ¨é¼ æ ‡æ¡†é€‰è¦è£å‰ªçš„åŒºåŸŸ
                    </p>
                </div>

                <div class="crop-list">
                    <h3>âœ… å·²è£å‰ª (<span id="cropCount">0</span>)</h3>
                    <div id="croppedList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        let currentImage = null;
        let isDrawing = false;
        let startX = 0, startY = 0;
        let currentX = 0, currentY = 0;
        let endX = 0, endY = 0;  // ä¿å­˜é€‰åŒºçš„æœ€ç»ˆåæ ‡
        let hasSelection = false;  // æ ‡è®°æ˜¯å¦æœ‰é€‰åŒº
        let croppedImages = [];

        // åŠ è½½ä¸Šä¼ çš„å›¾ç‰‡ï¼ˆä½¿ç”¨ FileReader é¿å… CORS é—®é¢˜ï¼‰
        function loadUploadedImage() {
            const fileInput = document.getElementById('imageUpload');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                showStatus('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const img = new Image();
                
                img.onload = function() {
                    currentImage = img;
                    
                    // è®¾ç½®canvaså¤§å°
                    const maxWidth = 900;
                    const scale = Math.min(1, maxWidth / img.width);
                    canvas.width = img.width * scale;
                    canvas.height = img.height * scale;
                    
                    // ç»˜åˆ¶å›¾ç‰‡
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    document.getElementById('cropBtn').disabled = false;
                    showStatus('å›¾ç‰‡åŠ è½½æˆåŠŸï¼å¯ä»¥å¼€å§‹æ¡†é€‰äº†', 'success');
                    
                    console.log('å›¾ç‰‡å·²åŠ è½½:', file.name, 'å°ºå¯¸:', img.width, 'x', img.height);
                };
                
                img.onerror = function() {
                    showStatus('å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
                };
                
                // ä½¿ç”¨ FileReader è¯»å–çš„ data URLï¼Œä¸ä¼šæœ‰ CORS é—®é¢˜
                img.src = e.target.result;
            };
            
            reader.onerror = function() {
                showStatus('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
            };
            
            // è¯»å–æ–‡ä»¶ä¸º Data URL
            reader.readAsDataURL(file);
        }
        
        // ä¿ç•™åŸæ¥çš„å‡½æ•°ï¼ˆæš‚æ—¶ä¸ç”¨ï¼‰
        function loadSelectedImage() {
            showStatus('è¯·ä½¿ç”¨"ä¸Šä¼ å›¾ç‰‡"æŒ‰é’®é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
        }

        // é¼ æ ‡äº‹ä»¶
        canvas.addEventListener('mousedown', (e) => {
            if (!currentImage) return;
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing || !currentImage) return;
            const rect = canvas.getBoundingClientRect();
            currentX = e.clientX - rect.left;
            currentY = e.clientY - rect.top;
            
            // é‡ç»˜å›¾ç‰‡å’Œé€‰åŒº
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶é€‰åŒº
            const width = currentX - startX;
            const height = currentY - startY;
            ctx.strokeStyle = '#d4a373';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(startX, startY, width, height);
            ctx.fillStyle = 'rgba(212, 163, 115, 0.1)';
            ctx.fillRect(startX, startY, width, height);
            ctx.setLineDash([]);
            
            // æ›´æ–°é€‰åŒºä¿¡æ¯
            document.getElementById('selectionInfo').innerHTML = `
                èµ·ç‚¹: (${Math.round(startX)}, ${Math.round(startY)})<br>
                å®½åº¦: ${Math.abs(Math.round(width))}px<br>
                é«˜åº¦: ${Math.abs(Math.round(height))}px
            `;
        });

        canvas.addEventListener('mouseup', (e) => {
            if (isDrawing && currentImage) {
                isDrawing = false;
                const rect = canvas.getBoundingClientRect();
                endX = e.clientX - rect.left;
                endY = e.clientY - rect.top;
                hasSelection = true;
                
                // ä¿æŒé€‰åŒºæ˜¾ç¤º
                const width = endX - startX;
                const height = endY - startY;
                
                if (Math.abs(width) > 10 && Math.abs(height) > 10) {
                    showStatus('âœ… é€‰åŒºå·²ç¡®å®šï¼Œç‚¹å‡»"è£å‰ªå¹¶ä¿å­˜"æŒ‰é’®', 'success');
                }
            }
        });

        // è£å‰ªå¹¶ä¿å­˜
        function cropAndSave() {
            console.log('cropAndSave è¢«è°ƒç”¨');
            
            if (!currentImage) {
                showStatus('è¯·å…ˆé€‰æ‹©å›¾ç‰‡', 'error');
                console.log('æ²¡æœ‰å›¾ç‰‡');
                return;
            }

            if (!hasSelection) {
                showStatus('è¯·å…ˆåœ¨å›¾ç‰‡ä¸Šæ¡†é€‰è¦è£å‰ªçš„åŒºåŸŸ', 'error');
                console.log('æ²¡æœ‰é€‰åŒº');
                return;
            }

            // ä½¿ç”¨ä¿å­˜çš„æœ€ç»ˆåæ ‡
            const width = endX - startX;
            const height = endY - startY;
            
            console.log('é€‰åŒºä¿¡æ¯:', { startX, startY, endX, endY, width, height });

            if (Math.abs(width) < 10 || Math.abs(height) < 10) {
                showStatus('é€‰åŒºå¤ªå°ï¼Œè¯·é‡æ–°é€‰æ‹©', 'error');
                console.log('é€‰åŒºå¤ªå°');
                return;
            }

            // è®¡ç®—å®é™…å›¾ç‰‡ä¸Šçš„åæ ‡ï¼ˆè€ƒè™‘ç¼©æ”¾ï¼‰
            const scaleX = currentImage.width / canvas.width;
            const scaleY = currentImage.height / canvas.height;
            
            const cropX = Math.min(startX, endX) * scaleX;
            const cropY = Math.min(startY, endY) * scaleY;
            const cropWidth = Math.abs(width) * scaleX;
            const cropHeight = Math.abs(height) * scaleY;
            
            console.log('è£å‰ªå‚æ•°:', { cropX, cropY, cropWidth, cropHeight, scaleX, scaleY });

            // åˆ›å»ºä¸´æ—¶canvasè¿›è¡Œè£å‰ª
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = cropWidth;
            tempCanvas.height = cropHeight;
            const tempCtx = tempCanvas.getContext('2d');
            
            console.log('å¼€å§‹ç»˜åˆ¶åˆ°ä¸´æ—¶canvas');
            
            tempCtx.drawImage(
                currentImage,
                cropX, cropY, cropWidth, cropHeight,
                0, 0, cropWidth, cropHeight
            );

            // ç”Ÿæˆæ–‡ä»¶å
            const episode = document.getElementById('episode').value;
            const outfitNum = document.getElementById('outfitNum').value;
            const itemNum = document.getElementById('itemNum').value;
            const fileName = `ep${episode}_outfit${outfitNum}_item${itemNum}.jpg`;
            
            console.log('æ–‡ä»¶å:', fileName);
            console.log('å¼€å§‹è½¬æ¢ä¸ºblob...');

            // è½¬æ¢ä¸ºblobå¹¶ä¿å­˜
            try {
                tempCanvas.toBlob((blob) => {
                    console.log('toBlob å›è°ƒè¢«æ‰§è¡Œ, blob:', blob);
                    
                    if (!blob) {
                        showStatus('ç”Ÿæˆå›¾ç‰‡å¤±è´¥', 'error');
                        console.error('blob ä¸ºç©º');
                        return;
                    }
                    
                    const url = URL.createObjectURL(blob);
                    console.log('åˆ›å»º URL:', url);
                    
                    // æ·»åŠ åˆ°å·²è£å‰ªåˆ—è¡¨
                    croppedImages.push({
                        fileName: fileName,
                        url: url,
                        blob: blob
                    });

                    // æ›´æ–°ç•Œé¢
                    updateCroppedList();
                    console.log('å·²æ›´æ–°è£å‰ªåˆ—è¡¨');
                    
                    // è‡ªåŠ¨ä¸‹è½½
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    console.log('è§¦å‘ä¸‹è½½');
                    
                    // ç¨åç§»é™¤
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);

                    showStatus(`âœ… å·²ä¿å­˜: ${fileName}`, 'success');
                    
                    // è‡ªåŠ¨å¢åŠ å•å“ç¼–å·
                    document.getElementById('itemNum').value = parseInt(itemNum) + 1;
                    
                    // é‡ç½®é€‰åŒº
                    resetSelection();
                }, 'image/jpeg', 0.95);
            } catch (error) {
                console.error('toBlob é”™è¯¯:', error);
                showStatus('è£å‰ªå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°å·²è£å‰ªåˆ—è¡¨
        function updateCroppedList() {
            const list = document.getElementById('croppedList');
            const count = document.getElementById('cropCount');
            
            count.textContent = croppedImages.length;
            
            list.innerHTML = croppedImages.map((img, index) => `
                <div class="crop-item">
                    <img src="${img.url}" alt="${img.fileName}">
                    <div class="crop-item-info">
                        <div class="crop-item-name">${img.fileName}</div>
                    </div>
                </div>
            `).join('');
        }

        // é‡ç½®é€‰åŒº
        function resetSelection() {
            if (currentImage) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            }
            hasSelection = false;
            startX = startY = endX = endY = currentX = currentY = 0;
            document.getElementById('selectionInfo').innerHTML = 'æœªé€‰æ‹©åŒºåŸŸ';
            showStatus('é€‰åŒºå·²é‡ç½®ï¼Œè¯·é‡æ–°æ¡†é€‰', 'success');
        }

        // ä¸‹è½½æ‰€æœ‰è£å‰ªå›¾
        function downloadAll() {
            if (croppedImages.length === 0) {
                showStatus('è¿˜æ²¡æœ‰è£å‰ªä»»ä½•å›¾ç‰‡', 'error');
                return;
            }

            croppedImages.forEach(img => {
                const a = document.createElement('a');
                a.href = img.url;
                a.download = img.fileName;
                a.click();
            });

            showStatus(`å·²ä¸‹è½½ ${croppedImages.length} å¼ å›¾ç‰‡`, 'success');
        }

        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            
            setTimeout(() => {
                status.className = 'status';
            }, 3000);
        }
    </script>
</body>
</html>

